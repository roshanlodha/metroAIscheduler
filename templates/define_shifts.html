<!DOCTYPE html>
<html>
<head>
    <title>Shift Builder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            padding: 32px 36px 28px 36px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 6px;
        }
        .subtitle {
            text-align: center;
            color: #555;
            font-size: 1.05em;
            margin-bottom: 20px;
        }
        label {
            font-weight: 500;
            color: #34495e;
            display: block;
            margin-bottom: 6px;
        }
        input[type="text"], input[type="time"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            transform: scale(1.2);
        }
        .row {
            display: flex;
            gap: 18px;
            margin-bottom: 20px;
        }
        .row .col {
            flex: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }
        th {
            background: #f2f6fa;
            font-weight: 600;
        }
        tbody tr:nth-child(even) {
            background: #fafafa;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        button, input[type="submit"] {
            background: #0078d4;
            color: #fff;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
        }
        button.secondary {
            background: #546e7a;
        }
        button.danger {
            background: #c0392b;
        }
        button:hover, input[type="submit"]:hover {
            background: #005fa3;
        }
        button.secondary:hover {
            background: #455a64;
        }
        button.danger:hover {
            background: #922b21;
        }
        input[type="submit"] {
            margin-top: 24px;
            width: 100%;
            font-size: 1.05em;
        }
        .message {
            margin-top: 18px;
            padding: 12px 16px;
            border-radius: 6px;
        }
        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .message.error {
            background: #fdecea;
            color: #c0392b;
        }
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shift Builder</h1>
        <div class="subtitle">
            Build a weekly template of shifts for any institution. Save it once, then reuse it on the <a href="{{ url_for('index') }}">schedule generator</a>.
        </div>

        {% if success %}
            <div class="message success">{{ success }}</div>
        {% endif %}
        {% if error %}
            <div class="message error">{{ error }}</div>
        {% endif %}

        <div class="row">
            <div class="col">
                <label for="existing_templates">Saved Templates</label>
                <select id="existing_templates">
                    <option value="">Create new…</option>
                    {% for tpl in templates %}
                        <option value="{{ tpl.slug }}" {% if selected_slug and selected_slug == tpl.slug %}selected{% endif %}>
                            {{ tpl.template_name }}{% if tpl.institution %} — {{ tpl.institution }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col" style="align-self: flex-end;">
                <button type="button" class="secondary" id="load_template_btn">Load Selected</button>
            </div>
        </div>

        <form method="post" id="template_form">
            <input type="hidden" name="week_slots" id="week_slots">
            <input type="hidden" name="slug" id="slug">

            <div class="row">
                <div class="col">
                    <label for="template_name">Template Name</label>
                    <input type="text" name="template_name" id="template_name" placeholder="e.g. MetroHealth Winter Block" required>
                </div>
                <div class="col">
                    <label for="institution">Institution</label>
                    <input type="text" name="institution" id="institution" placeholder="e.g. MetroHealth" required>
                </div>
            </div>

            <div class="actions">
                <button type="button" id="add_shift_btn">Add Shift</button>
                <button type="button" class="secondary" id="clear_shifts_btn">Clear All</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Site</th>
                        <th>Start</th>
                        <th>Duration (hrs)</th>
                        <th>Block Window (hrs)</th>
                        <th>Overnight</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="shift_rows">
                    <tr class="empty">
                        <td colspan="9" class="empty-state">No shifts yet. Click “Add Shift” to get started.</td>
                    </tr>
                </tbody>
            </table>

            <input type="submit" value="Save Template">
        </form>
    </div>

    <script>
        const dayOptions = [
            'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'
        ];
        const templateData = {{ template_data | tojson | safe }};
        let shiftRows = [];

        const shiftRowsContainer = document.getElementById('shift_rows');
        const weekSlotsInput = document.getElementById('week_slots');
        const slugInput = document.getElementById('slug');

        function renderRows() {
            shiftRowsContainer.innerHTML = '';
            if (shiftRows.length === 0) {
                const row = document.createElement('tr');
                row.classList.add('empty');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.className = 'empty-state';
                cell.textContent = 'No shifts yet. Click “Add Shift” to get started.';
                row.appendChild(cell);
                shiftRowsContainer.appendChild(row);
                return;
            }

            shiftRows.forEach((shift, index) => {
                const tr = document.createElement('tr');

                // Day select
                const dayTd = document.createElement('td');
                const daySelect = document.createElement('select');
                dayOptions.forEach(day => {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    if (shift.day_of_week === day) {
                        option.selected = true;
                    }
                    daySelect.appendChild(option);
                });
                daySelect.addEventListener('change', (e) => {
                    shiftRows[index].day_of_week = e.target.value;
                });
                dayTd.appendChild(daySelect);
                tr.appendChild(dayTd);

                function createInputCell(field, type = 'text') {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = type;
                    if (type === 'number') {
                        input.step = '0.5';
                        input.min = '0';
                    }
                    input.value = shift[field] != null ? shift[field] : '';
                    input.addEventListener('input', (e) => {
                        shiftRows[index][field] = type === 'number' ? e.target.value : e.target.value;
                    });
                    td.appendChild(input);
                    return td;
                }

                tr.appendChild(createInputCell('name', 'text'));
                tr.appendChild(createInputCell('category', 'text'));
                tr.appendChild(createInputCell('site', 'text'));

                const startTd = document.createElement('td');
                const startInput = document.createElement('input');
                startInput.type = 'time';
                startInput.value = shift.start_time || '07:00';
                startInput.addEventListener('change', (e) => {
                    shiftRows[index].start_time = e.target.value;
                });
                startTd.appendChild(startInput);
                tr.appendChild(startTd);

                tr.appendChild(createInputCell('duration_hours', 'number'));
                tr.appendChild(createInputCell('block_hours', 'number'));

                const overnightTd = document.createElement('td');
                const overnightInput = document.createElement('input');
                overnightInput.type = 'checkbox';
                overnightInput.checked = Boolean(shift.is_overnight);
                overnightInput.addEventListener('change', (e) => {
                    shiftRows[index].is_overnight = e.target.checked;
                });
                overnightTd.appendChild(overnightInput);
                tr.appendChild(overnightTd);

                const actionsTd = document.createElement('td');
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'danger';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', () => {
                    shiftRows.splice(index, 1);
                    renderRows();
                });
                actionsTd.appendChild(removeBtn);
                tr.appendChild(actionsTd);

                shiftRowsContainer.appendChild(tr);
            });
        }

        function addShift(initial = {}) {
            shiftRows.push({
                day_of_week: initial.day_of_week || 'Monday',
                name: initial.name || '',
                category: initial.category || '',
                site: initial.site || '',
                start_time: initial.start_time || '07:00',
                duration_hours: initial.duration_hours ?? 10,
                block_hours: initial.block_hours ?? initial.duration_hours ?? 10,
                is_overnight: Boolean(initial.is_overnight),
            });
            renderRows();
        }

        document.getElementById('add_shift_btn').addEventListener('click', () => addShift());
        document.getElementById('clear_shifts_btn').addEventListener('click', () => {
            if (shiftRows.length === 0 || confirm('Remove all shifts from this template?')) {
                shiftRows = [];
                renderRows();
            }
        });

        document.getElementById('load_template_btn').addEventListener('click', () => {
            const selector = document.getElementById('existing_templates');
            const slug = selector.value;
            if (!slug) {
                // reset to blank new template
                slugInput.value = '';
                document.getElementById('template_name').value = '';
                document.getElementById('institution').value = '';
                shiftRows = [];
                renderRows();
                return;
            }
            const template = templateData[slug];
            if (!template) {
                alert('Unable to load template data.');
                return;
            }
            slugInput.value = slug;
            document.getElementById('template_name').value = template.template_name || '';
            document.getElementById('institution').value = template.institution || '';
            shiftRows = (template.week_slots || []).map(slot => ({
                day_of_week: slot.day_of_week || 'Monday',
                name: slot.name || '',
                category: slot.category || '',
                site: slot.site || '',
                start_time: slot.start_time || '07:00',
                duration_hours: slot.duration_hours ?? 10,
                block_hours: slot.block_hours ?? slot.duration_hours ?? 10,
                is_overnight: Boolean(slot.is_overnight),
            }));
            renderRows();
        });

        document.getElementById('template_form').addEventListener('submit', (event) => {
            if (shiftRows.length === 0) {
                const proceed = confirm('This template has no shifts. Save anyway?');
                if (!proceed) {
                    event.preventDefault();
                    return;
                }
            }
            weekSlotsInput.value = JSON.stringify(shiftRows);
        });

        // Auto-load when arriving via "select" query param
        const autoSelect = '{{ selected_slug or '' }}';
        if (autoSelect) {
            const selector = document.getElementById('existing_templates');
            selector.value = autoSelect;
            document.getElementById('load_template_btn').click();
        }

        renderRows();
    </script>
</body>
</html>
